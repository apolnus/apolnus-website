import { useState } from "react";
import { useLocation } from "wouter";
import { useAuth } from "@/hooks/useAuth";
import { trpc } from "@/lib/trpc";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { toast } from "sonner";
import { ArrowLeft } from "lucide-react";
import Navbar from "@/components/Navbar";
import Footer from "@/components/Footer";
import { useTranslation } from "react-i18next";
import SEOHead from "@/components/seo/SEOHead";

export default function SupportTicket() {
  const { t } = useTranslation();
  const [, setLocation] = useLocation();
  const { user } = useAuth();
  const [formData, setFormData] = useState({
    contactName: user?.name || "",
    contactPhone: "",
    contactAddress: "",
    productModel: "",
    productSerial: "",
    purchaseDate: "",
    purchaseChannel: "",
    issueTitle: "",
    issueDescription: "",
  });

  const { data: productModels } = trpc.admin.productModels.list.useQuery();
  const createTicket = trpc.tickets.create.useMutation({
    onSuccess: () => {
      toast.success("工單已成功提交！");
      setLocation("/profile");
    },
    onError: (error) => {
      toast.error(`提交失敗：${error.message}`);
    },
  });

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();

    // Validation
    if (
      !formData.contactName ||
      !formData.contactPhone ||
      !formData.contactAddress ||
      !formData.productModel ||
      !formData.issueTitle ||
      !formData.issueDescription
    ) {
      toast.error("請填寫所有必填欄位");
      return;
    }

    createTicket.mutate({
      contactName: formData.contactName,
      contactPhone: formData.contactPhone,
      contactAddress: formData.contactAddress,
      productModel: formData.productModel,
      productSerial: formData.productSerial || undefined,
      purchaseDate: formData.purchaseDate || undefined,
      purchaseChannel: formData.purchaseChannel || undefined,
      issueTitle: formData.issueTitle,
      issueDescription: formData.issueDescription,
    });
  };

  const handleCancel = () => {
    setLocation("/support");
  };

  return (
    <>
      <Navbar />
      <div className="min-h-screen bg-gray-50 pt-16">
        <div className="container mx-auto px-6 py-12">
          {/* Back Button */}
          <button
            onClick={() => setLocation("/support")}
            className="flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900 mb-6"
          >
            <ArrowLeft className="w-4 h-4" />
            返回
          </button>

          {/* Page Header */}
          <div className="mb-8">
            <h1 className="text-3xl font-bold text-gray-900 mb-2">建立工單</h1>
            <p className="text-gray-600">
              請詳細描述您遇到的問題，我們會盡快為您處理
            </p>
          </div>

          {/* Form */}
          <form onSubmit={handleSubmit} className="bg-white rounded-lg shadow-sm p-8 max-w-3xl">
            <div className="space-y-6">
              {/* Contact Name */}
              <div>
                <Label htmlFor="contactName">
                  聯絡人姓名 <span className="text-red-500">*</span>
                </Label>
                <Input
                  id="contactName"
                  value={formData.contactName}
                  onChange={(e) =>
                    setFormData({ ...formData, contactName: e.target.value })
                  }
                  placeholder="請輸入姓名"
                  className="mt-1"
                />
              </div>

              {/* Contact Phone */}
              <div>
                <Label htmlFor="contactPhone">
                  聯絡電話 <span className="text-red-500">*</span>
                </Label>
                <Input
                  id="contactPhone"
                  value={formData.contactPhone}
                  onChange={(e) =>
                    setFormData({ ...formData, contactPhone: e.target.value })
                  }
                  placeholder="請輸入聯絡電話"
                  className="mt-1"
                />
              </div>

              {/* Contact Address */}
              <div>
                <Label htmlFor="contactAddress">
                  聯絡地址 <span className="text-red-500">*</span>
                </Label>
                <Input
                  id="contactAddress"
                  value={formData.contactAddress}
                  onChange={(e) =>
                    setFormData({ ...formData, contactAddress: e.target.value })
                  }
                  placeholder="請輸入地址"
                  className="mt-1"
                />
              </div>

              {/* Product Model */}
              <div>
                <Label htmlFor="productModel">
                  產品型號 <span className="text-red-500">*</span>
                </Label>
                <Select
                  value={formData.productModel}
                  onValueChange={(value) =>
                    setFormData({ ...formData, productModel: value })
                  }
                >
                  <SelectTrigger className="mt-1">
                    <SelectValue placeholder="請選擇產品型號" />
                  </SelectTrigger>
                  <SelectContent>
                    {productModels?.map((model) => (
                      <SelectItem key={model.id} value={model.name}>
                        {model.name}
                      </SelectItem>
                    ))}
                    <SelectItem value="其他">其他</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              {/* Product Serial */}
              <div>
                <Label htmlFor="productSerial">產品序號 (選填)</Label>
                <Input
                  id="productSerial"
                  value={formData.productSerial}
                  onChange={(e) =>
                    setFormData({ ...formData, productSerial: e.target.value })
                  }
                  placeholder="請輸入產品序號"
                  className="mt-1"
                />
              </div>

              {/* Purchase Date */}
              <div>
                <Label htmlFor="purchaseDate">訂購日期 (選填)</Label>
                <Input
                  id="purchaseDate"
                  type="date"
                  value={formData.purchaseDate}
                  onChange={(e) =>
                    setFormData({ ...formData, purchaseDate: e.target.value })
                  }
                  className="mt-1"
                />
              </div>

              {/* Purchase Channel */}
              <div>
                <Label htmlFor="purchaseChannel">訂購通路 (選填)</Label>
                <Select
                  value={formData.purchaseChannel}
                  onValueChange={(value) =>
                    setFormData({ ...formData, purchaseChannel: value })
                  }
                >
                  <SelectTrigger className="mt-1">
                    <SelectValue placeholder="請選擇訂購通路" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="官方網站">官方網站</SelectItem>
                    <SelectItem value="授權經銷商">授權經銷商</SelectItem>
                    <SelectItem value="線上商城">線上商城</SelectItem>
                    <SelectItem value="實體店面">實體店面</SelectItem>
                    <SelectItem value="其他">其他</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              {/* Issue Title */}
              <div>
                <Label htmlFor="issueTitle">
                  問題標題 <span className="text-red-500">*</span>
                </Label>
                <Input
                  id="issueTitle"
                  value={formData.issueTitle}
                  onChange={(e) =>
                    setFormData({ ...formData, issueTitle: e.target.value })
                  }
                  placeholder="請輸入問題標題"
                  className="mt-1"
                />
              </div>

              {/* Issue Description */}
              <div>
                <Label htmlFor="issueDescription">
                  問題描述 <span className="text-red-500">*</span>
                </Label>
                <Textarea
                  id="issueDescription"
                  value={formData.issueDescription}
                  onChange={(e) =>
                    setFormData({ ...formData, issueDescription: e.target.value })
                  }
                  placeholder="請詳細描述您遇到的問題"
                  rows={6}
                  className="mt-1"
                />
              </div>

              {/* Buttons */}
              <div className="flex gap-4 pt-4">
                <Button
                  type="submit"
                  disabled={createTicket.isPending}
                  className="flex-1"
                >
                  {createTicket.isPending ? "提交中..." : "提交工單"}
                </Button>
                <Button
                  type="button"
                  variant="outline"
                  onClick={handleCancel}
                  className="flex-1"
                >
                  取消
                </Button>
              </div>
            </div>
          </form>
        </div>
      </div>
      <Footer />
    </>
  );
}
