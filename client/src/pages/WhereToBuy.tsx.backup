import { useState, useMemo } from "react";
import { ShoppingCart, ExternalLink, Store, MapPin, Phone, Search } from "lucide-react";
import { Button } from "@/components/ui/button";
import Navbar from "@/components/Navbar";
import Footer from "@/components/Footer";
import { trpc } from "@/lib/trpc";
import { useTranslation } from "react-i18next";
import SEOHead from "@/components/seo/SEOHead";

export default function WhereToBuy() {
  const { t } = useTranslation();
  const [activeTab, setActiveTab] = useState<"online" | "dealers">("online");
  const [selectedCity, setSelectedCity] = useState<string>("all");
  const [selectedDistrict, setSelectedDistrict] = useState<string>("all");
  const [searchKeyword, setSearchKeyword] = useState<string>("");
  const { data: dealersData } = trpc.dealers.getDealers.useQuery();

  const onlinePlatforms = [
    {
      name: "Apolnus 官方商城",
      description: "官方直營，品質保證，享有完整售後服務",
      url: "https://store.apolnus.com/",
    },
    {
      name: "momo購物網",
      description: "台灣最大購物平台,快速到貨服務",
      url: "https://www.momoshop.com.tw/category/DgrpCategory.jsp?d_code=2902000549&p_orderType=4&showType=chessboardType",
    },
    {
      name: "PChome 24h購物",
      description: "24小時到貨，購物便利",
      url: "https://24h.pchome.com.tw/store/DMAUEL",
    },
    {
      name: "蝦皮商城",
      description: "多元支付，優惠活動",
      url: "https://shopee.tw/shop/911049095",
    },
  ];

  // 使用從 API 獲取的經銷商資料，如果沒有則顯示空陣列
  const allDealers = dealersData || [];

  // Parse city and district from address
  const parseAddress = (address: string) => {
    // 嘗試解析逗號分隔格式："街道, 區域, 縣市"
    const parts = address.split(", ");
    if (parts.length >= 3) {
      return {
        street: parts[0],
        district: parts[1],
        city: parts[2],
      };
    }
    
    // 解析台灣地址格式："縣市+區域+街道"
    const cityMatch = address.match(/^([一-龥]+[市縣])/); // 匹配縣市
    const districtMatch = address.match(/[市縣]([一-龥]+[區鄉鎮市])/); // 匹配區域
    
    if (cityMatch && districtMatch) {
      const city = cityMatch[1];
      const district = districtMatch[1];
      const street = address.substring(city.length + district.length);
      return { city, district, street };
    }
    
    return { street: address, district: "", city: "" };
  };

  // Get unique cities
  const cities = useMemo(() => {
    const citySet = new Set<string>();
    allDealers.forEach((dealer) => {
      const { city } = parseAddress(dealer.address);
      if (city) citySet.add(city);
    });
    return Array.from(citySet).sort();
  }, [allDealers]);

  // Get districts for selected city
  const districts = useMemo(() => {
    if (selectedCity === "all") return [];
    const districtSet = new Set<string>();
    allDealers.forEach((dealer) => {
      const { city, district } = parseAddress(dealer.address);
      if (city === selectedCity && district) {
        districtSet.add(district);
      }
    });
    return Array.from(districtSet).sort();
  }, [allDealers, selectedCity]);

  // Filter dealers
  const dealers = useMemo(() => {
    return allDealers.filter((dealer) => {
      const { city, district } = parseAddress(dealer.address);
      
      // City filter
      if (selectedCity !== "all" && city !== selectedCity) {
        return false;
      }
      
      // District filter
      if (selectedDistrict !== "all" && district !== selectedDistrict) {
        return false;
      }
      
      // Keyword search
      if (searchKeyword) {
        const keyword = searchKeyword.toLowerCase();
        return (
          dealer.name.toLowerCase().includes(keyword) ||
          dealer.address.toLowerCase().includes(keyword) ||
          dealer.phone.includes(keyword)
        );
      }
      
      return true;
    });
  }, [allDealers, selectedCity, selectedDistrict, searchKeyword]);

  // Handle city change
  const handleCityChange = (value: string) => {
    setSelectedCity(value);
    setSelectedDistrict("all");
  };

  return (
    <div className="min-h-screen flex flex-col bg-white">
      <Navbar />
      
      {/* Hero Section */}
      <section className="bg-[#1a2332] text-white py-16">
        <div className="container">
          <h1 className="text-4xl md:text-5xl font-bold mb-4">{t('whereToBuy.title')}</h1>
          <p className="text-lg text-gray-300">{t('whereToBuy.subtitle')}</p>
        </div>
      </section>

      {/* Tabs */}
      <div className="border-b bg-white sticky top-16 z-10">
        <div className="container">
          <div className="flex gap-4">
            <button
              onClick={() => setActiveTab("online")}
              className={`px-6 py-4 font-medium transition-colors relative ${
                activeTab === "online"
                  ? "text-blue-600 border-b-2 border-blue-600"
                  : "text-gray-600 hover:text-gray-900"
              }`}
            >
              官方線上通路
            </button>
            <button
              onClick={() => setActiveTab("dealers")}
              className={`px-6 py-4 font-medium transition-colors relative ${
                activeTab === "dealers"
                  ? "text-blue-600 border-b-2 border-blue-600"
                  : "text-gray-600 hover:text-gray-900"
              }`}
            >
              授權經銷商
            </button>
          </div>
        </div>
      </div>

      {/* Content */}
      <div className="flex-1 py-12">
        <div className="container">
          {activeTab === "online" ? (
            <div className="space-y-12">
              {/* Featured Section */}
              <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl p-8 md:p-12">
                <div className="grid md:grid-cols-2 gap-8 items-center">
                  <div>
                    <div className="inline-block bg-blue-600 text-white px-4 py-1 rounded-full text-sm font-medium mb-4">
                      官方推薦
                    </div>
                    <h2 className="text-3xl font-bold mb-6">Apolnus 官方商城</h2>
                    <div className="space-y-3 mb-8">
                      <div className="flex items-start gap-3">
                        <svg className="w-6 h-6 text-blue-600 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                        </svg>
                        <p className="text-gray-700">提供官方產品和全方位服務，讓您的購買更有保障</p>
                      </div>
                      <div className="flex items-start gap-3">
                        <svg className="w-6 h-6 text-blue-600 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                        </svg>
                        <p className="text-gray-700">購物回饋會員點數，享專屬優惠</p>
                      </div>
                      <div className="flex items-start gap-3">
                        <svg className="w-6 h-6 text-blue-600 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                        </svg>
                        <p className="text-gray-700">專業客服團隊協助選購</p>
                      </div>
                      <div className="flex items-start gap-3">
                        <svg className="w-6 h-6 text-blue-600 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                        </svg>
                        <p className="text-gray-700">最多 30 天退換貨保障</p>
                      </div>
                    </div>
                    <Button className="bg-blue-600 hover:bg-blue-700 text-white">
                      立即購買
                      <ExternalLink className="ml-2 h-4 w-4" />
                    </Button>
                  </div>
                  <div className="flex items-center justify-center">
                    <div className="w-64 h-64 bg-white rounded-full flex items-center justify-center shadow-xl">
                      <div className="inline-block bg-yellow-400 text-gray-900 px-4 py-1 rounded-full text-sm font-medium mb-2 absolute top-8 right-8">
                        官方直營
                      </div>
                      <ShoppingCart className="w-32 h-32 text-blue-600" />
                    </div>
                  </div>
                </div>
              </div>

              {/* Online Platforms */}
              <div>
                <h3 className="text-2xl font-bold mb-2">線上購物平台</h3>
                <p className="text-gray-600 mb-8">在您熟悉的電商平台購買 Apolnus 產品</p>
                <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                  {onlinePlatforms.map((platform, index) => (
                    <a
                      key={index}
                      href={platform.url}
                      className="block p-6 border rounded-xl hover:shadow-lg transition-shadow bg-white"
                    >
                      <Store className="w-8 h-8 text-blue-600 mb-4" />
                      <h4 className="font-bold text-lg mb-2">{platform.name}</h4>
                      <p className="text-sm text-gray-600">{platform.description}</p>
                    </a>
                  ))}
                </div>
              </div>

              {/* CTA Section */}
              <div className="bg-gray-50 rounded-2xl p-8 text-center">
                <h3 className="text-2xl font-bold mb-2">需要購買建議？</h3>
                <p className="text-gray-600 mb-6">我們的專業團隊隨時為您提供產品諮詢服務</p>
                <div className="flex gap-4 justify-center flex-wrap">
                  <Button variant="outline" className="border-gray-300">
                    聯絡我們
                  </Button>
                  <Button className="bg-blue-600 hover:bg-blue-700 text-white">
                    前往官方商城
                  </Button>
                </div>
              </div>
            </div>
          ) : (
            <div>
              {/* Filter Section */}
              <div className="bg-gray-50 rounded-xl p-6 mb-8">
                <p className="text-gray-700 mb-6">
                  在我司正式授權的代理商處購買的波那斯產品，以確保您能及時獲得保固服務。
                </p>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  {/* City Filter */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      縣市
                    </label>
                    <select
                      value={selectedCity}
                      onChange={(e) => handleCityChange(e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="all">{t('whereToBuy.text_8266')}</option>
                      {cities.map((city) => (
                        <option key={city} value={city}>
                          {city}
                        </option>
                      ))}
                    </select>
                  </div>

                  {/* District Filter */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      區域
                    </label>
                    <select
                      value={selectedDistrict}
                      onChange={(e) => setSelectedDistrict(e.target.value)}
                      disabled={selectedCity === "all"}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"
                    >
                      <option value="all">{t('whereToBuy.text_5160')}</option>
                      {districts.map((district) => (
                        <option key={district} value={district}>
                          {district}
                        </option>
                      ))}
                    </select>
                  </div>

                  {/* Search */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      關鍵字搜尋
                    </label>
                    <div className="relative">
                      <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                      <input
                        type="text"
                        placeholder={t('whereToBuy.text_3042')}
                        value={searchKeyword}
                        onChange={(e) => setSearchKeyword(e.target.value)}
                        className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                    </div>
                  </div>
                </div>

                {/* Clear Filters */}
                {(selectedCity !== "all" || selectedDistrict !== "all" || searchKeyword) && (
                  <div className="mt-4">
                    <button
                      onClick={() => {
                        setSelectedCity("all");
                        setSelectedDistrict("all");
                        setSearchKeyword("");
                      }}
                      className="text-sm text-blue-600 hover:text-blue-700 font-medium"
                    >
                      清除所有篩選
                    </button>
                  </div>
                )}
              </div>

              <p className="text-gray-600 mb-6">找到 {dealers.length} 個授權經銷商</p>
              <div className="grid gap-6">
                {dealers.length > 0 ? (
                  dealers.map((dealer) => (
                    <div key={dealer.id} className="border rounded-xl p-6 hover:shadow-lg transition-shadow bg-white">
                      <div className="flex items-start gap-4">
                        <Store className="w-8 h-8 text-blue-600 flex-shrink-0" />
                        <div className="flex-1">
                          <h3 className="font-bold text-lg mb-3">{dealer.name}</h3>
                          <div className="space-y-2 text-gray-600">
                            <div className="flex items-center gap-2">
                              <Phone className="w-4 h-4" />
                              <span>{dealer.phone}</span>
                            </div>
                            <div className="flex items-start gap-2">
                              <MapPin className="w-4 h-4 mt-0.5" />
                              <span>{dealer.address}</span>
                            </div>
                            {dealer.businessHours && (
                              <div className="text-sm text-gray-500">
                                營業時間：{dealer.businessHours}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  ))
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    目前尚無授權經銷商資料
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      </div>

      <Footer />
    </div>
  );
}
